<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Jan Vraný - About PoolDictionary in Bee - Part I.</title>
    <link rel="stylesheet" href="/pygments.css">
    <link rel="stylesheet" href="/stylesheet.css">
    

    <!-- you don't need to keep this, but it's cool for stats! -->
    <meta name="generator" content="Nanoc 4.9.3">
  </head>
  <body>
    <div id="header">
      <div id="jv">
        Jan Vraný
      </div>

    	<ul>
    	<li><a href="/">home</a></li>
    	<li><a href="/posts">blog</a></li>
        <li><a href="/projects">projects</a></li>                      
        <li><a href="https://bitbucket.org/janvrany/">repositories</a></li>
        <li><a href="/contact">contact</a></li>        
        <li><a href="/cv.pdf">cv</a></li>
    	</ul>
    </div>
    <div id="main">
      
  <div class="column width3_4 post">
    <h1>About PoolDictionary in Bee - Part I.</h1>
    <aside>Posted at: May 17, 2018</aside>
    <article>
      <h1 id="foreword">Foreword</h1>

<!-- more -->

<h1 id="problem">Problem</h1>

<p>While working on external structures in Bee, in some cases I had to remove extra 
keys from <code>Offsets</code> local pool dictionary that keeps byte offsets of structure
members. Since I automate everything I needed to generate a smalltalk code that
removes them. Removing as such is rather straightforward:</p>

<p><code>
#!smalltalk
(TIMESTAMP_STRUCT classVariables at: 'Offsets') removeKey: 'timezone_minute'
</code></p>

<p>The only problem is that methods that may have used the value would keep using 
it as before and no-one would not notice. No runtime error, nothing. But is that
really a problem? I mean, given the way access to pool variable is implemented
and the way (pool) <code>Dictionary</code> is implemented, this behavior is logical and to
be expected, so why bother.</p>

<p>I think it is a concern. Maybe not for Bee developers but from a system design 
point of view. Consider following: if you remove a method from class, immediately
afterwards any code, existing or not, that calls that method on instance of that
particular class ends up with an runtime error - a famous <code>MessageNotUnderstood</code>. 
This is not for free nor a side-effect of the implementation, both the runtime
and smalltalk kernel is carefully designed to ensure this. How is it different
from this case?</p>

<h1 id="solution">Solution</h1>

<p>A partial solution is rather simple. We just make sure that methods that are
were accessing the removed pool variable would no longer return some other
value denoting the variable has been removed. So:</p>

<p>````
#!smalltalk
removedValueForKey: key value: value
	^nil</p>

<p>privateRemoveKey: key ifAbsent: aBlock
	| assoc |
	assoc := contents lookupKey: key.
	assoc isNil ifTrue: [^aBlock value].
	assoc value: (self removedValueForKey: assoc key value: assoc value).
	^super privateRemoveKey: key ifAbsent: [self error: ‘Should not be reached’]</p>

<p>removeAll
	contents
		elementsDo: [:assoc | assoc
			value: (self removedValueForKey: assoc key value: assoc value)]
		count: self size.
	super removeAll
````</p>

<p>In this case, we’re using <code>nil</code> value as value that denotes removed variable.</p>

    </article>    
    <script src="https://apis.google.com/js/plusone.js"></script>
    <div id="comments"></div>
    <script>
    gapi.comments.render('comments', {
        href: window.location,
        width: '624',
        first_party_property: 'BLOGGER',
        view_type: 'FILTERED_POSTMOD'
    });
    </script>    
  </div>
  
    <div class="column width1_4">
      
        
          <h2><a href="/2018/09/vdb-01.html">Using rr and Visual/VM Debugger to debug Smalltalk/X crash</a></h2>      
        
      
        
      
        
          <h2><a href="/2018/01/fun-with-zfs-part-2-creating-debian-zfs-rescue-usb-image.html">Fun with ZFS, part 2: Creating Debian ZFS Rescue USB Image</a></h2>      
        
      
        
          <h2><a href="/2017/08/csr-mini-howto.html">How to generate TSL/SSL certificate and get it signed</a></h2>      
        
      
        
          <h2><a href="/2017/06/stx-libjava-used-for-real.html">STX:LIBJAVA used for real</a></h2>      
        
      
        
          <h2><a href="/2017/06/unamaged-delegates.html">Unmanaged delegates in CLR</a></h2>      
        
      
        
          <h2><a href="/2017/01/debugging-mixed-native-clr-application-in-windbg.html">Debugging mixed native-CLR application in WinDBG</a></h2>      
        
      
        
          <h2><a href="/2016/10/a-taste-of-dotNET-in-Bee-Smalltalk.html">A taste of .NET in Bee Smalltalk</a></h2>      
        
      
        
          <h2><a href="/2016/10/fun-with-zfs-part-1-installing-debian-jessie-on-zfs-root.html">Fun with ZFS, part 1: Installing Debian Jessie on ZFS Root</a></h2>      
        
      
        
          <h2><a href="/2016/10/first-post.html">First Post</a></h2>      
        
      
    </div>
  


    </div>
    <script>
  	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  	ga('create', 'UA-80636532-1', 'auto');
  	ga('send', 'pageview');
    </script>
  </body>
</html>
