<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Jan Vraný - msmtpd: how to setup super-light relay-only MTA</title>
    <link rel="stylesheet" href="/pygments.css">
    <link rel="stylesheet" href="/stylesheet.css">
    

    <!-- you don't need to keep this, but it's cool for stats! -->
    <meta name="generator" content="Nanoc 4.11.18">
  </head>
  <body>
    <div id="header">
      <div id="jv">
        Jan Vraný
      </div>

    	<ul>
    	<li><a href="/">home</a></li>
    	<li><a href="/posts">blog</a></li>
        <li><a href="/projects">projects</a></li>                      
        <li><a href="https://bitbucket.org/janvrany/">repositories</a></li>
        <li><a href="/contact">contact</a></li>        
        <li><a href="/cv.pdf">cv</a></li>
    	</ul>
    </div>
    <div id="main">
      
  <div class="column width3_4 post">
    <h1>msmtpd: how to setup super-light relay-only MTA</h1>
    <aside>Posted at: February 8, 2022</aside>
    <article>
      <p>This post describes how to setup <code>msmtpd</code> as local relay-only
SMTP server on Debian.</p>

<!-- more -->

<ol>
  <li>
    <p>Install <a href="https://marlam.de/msmtp/">msmtpd</a></p>

    <pre><code>sudo apt install msmtp-mta bsd-mailx
</code></pre>
  </li>
  <li>
    <p>Since we’d like to use socket-activated service (to save resources),
completely disable <code>msmtpd.service</code>:</p>

    <pre><code>sudo systemctl mask msmtpd.service
</code></pre>
  </li>
  <li>
    <p>Create socket unit for <code>msmtpd</code>. Run…</p>

    <pre><code>sudo systemctl edit --force --full msmtpd.socket
</code></pre>

    <p>…and when editor opens, type in:</p>

    <pre><code>[Socket]
ListenStream=25
Accept=yes

[Install]
WantedBy=sockets.target
</code></pre>
  </li>
  <li>
    <p>Create service unit for <code>msmtpd</code>. Run…</p>

    <pre><code>sudo systemctl edit --force --full msmtpd@.service
</code></pre>

    <p>…and when editor opens, type in:</p>

    <pre><code>[Unit]
Description=msmtp daemon
Documentation=man:msmtpd(1)

[Service]
User=msmtp
ProtectHome=true
PrivateTmp=true
NoNewPrivileges=true
SupplementaryGroups=msmtp

StandardInput=socket
ExecStart=/usr/sbin/msmtpd --inet '--command=/usr/bin/msmtp -C /etc/msmtprc.relay -f %%F'
</code></pre>
  </li>
  <li>
    <p>Now it’s time to configure relay SMTP server. Run…</p>

    <pre><code>sudo touch /etc/msmtprc.relay
sudo chmod go-rwx /etc/msmtprc.relay
sudo chown msmtp /etc/msmtprc.relay
sudo nano /etc/msmtprc.relay
</code></pre>

    <p>…and when editor opens, type in:</p>

    <pre><code>tls on
tls_starttls on
host smtp.gmail.com
port 587
tls_starttls on
auth on
user joe@gmail.com
password joessecret
from joe@gmail.com
aliases /etc/aliases
</code></pre>

    <p style="color: red; font-size: 200%">BIG FAT WARNING:</p>

    <p>This leaves passeword in clear text in file <code>/etc/msmtprc.relay</code> - this is <em>insecure</em>. The file is readable only by user <code>msmtp</code> but still. Unfortunately, I could not find another, more secure way to pass down password.</p>
  </li>
  <li>
    <p>Disable apparmor for <code>msmtp</code>:</p>

    <pre><code>sudo ln -s /etc/apparmor.d/usr.bin.msmtp /etc/apparmor.d/disable
sudo apparmor_parser -R /etc/apparmor.d/usr.bin.msmtp
</code></pre>

    <p>Sadly, I could not make it working otherwise.</p>
  </li>
  <li>
    <p>Enable and start <code>msmtpd</code> socket unit:</p>

    <pre><code>sudo systemctl enable msmtpd.socket
sudo systemctl start msmtpd.socket
</code></pre>
  </li>
  <li>
    <p>Now configure local mail:</p>

    <pre><code>sudo touch /etc/msmtprc
sudo chmod ugo+r /etc/msmtprc
sudo nano /etc/msmtprc
</code></pre>

    <p>…and when editor opens, type in:</p>

    <pre><code>account default
host localhost
port 25
</code></pre>

    <p>This causes local mail (sent by cron and other tools) to use just
configured local SMTP relay. Other machines in local network
(virtual or not) may be configured the same way.</p>
  </li>
</ol>


    </article>    
    <script src="https://apis.google.com/js/plusone.js"></script>
    <div id="comments"></div>
    <script>
    gapi.comments.render('comments', {
        href: window.location,
        width: '624',
        first_party_property: 'BLOGGER',
        view_type: 'FILTERED_POSTMOD'
    });
    </script>    
  </div>
  
    <div class="column width1_4">
      
        
      
        
          <h2><a href="/2021/07/developing-openj9-jit-for-risc-v.html">Developing OpenJ9 JIT for RISC-V</a></h2>      
        
      
        
          <h2><a href="/2020/09/using-eclipse-cdt-for-omr-development.html">Using Eclipse CDT for Eclipse OMR development</a></h2>      
        
      
        
          <h2><a href="/2018/09/vdb-01.html">Using rr and Visual/VM Debugger to debug Smalltalk/X crash</a></h2>      
        
      
        
          <h2><a href="/2018/01/fun-with-zfs-part-2-creating-debian-zfs-rescue-usb-image.html">Fun with ZFS, part 2: Creating Debian ZFS Rescue USB Image</a></h2>      
        
      
        
          <h2><a href="/2017/08/csr-mini-howto.html">How to generate TSL/SSL certificate and get it signed</a></h2>      
        
      
        
          <h2><a href="/2017/06/stx-libjava-used-for-real.html">STX:LIBJAVA used for real</a></h2>      
        
      
        
          <h2><a href="/2017/06/unamaged-delegates.html">Unmanaged delegates in CLR</a></h2>      
        
      
        
          <h2><a href="/2017/01/debugging-mixed-native-clr-application-in-windbg.html">Debugging mixed native-CLR application in WinDBG</a></h2>      
        
      
        
          <h2><a href="/2016/10/a-taste-of-dotNET-in-Bee-Smalltalk.html">A taste of .NET in Bee Smalltalk</a></h2>      
        
      
        
          <h2><a href="/2016/10/fun-with-zfs-part-1-installing-debian-jessie-on-zfs-root.html">Fun with ZFS, part 1: Installing Debian Jessie on ZFS Root</a></h2>      
        
      
        
          <h2><a href="/2016/10/first-post.html">First Post</a></h2>      
        
      
    </div>
  


    </div>
    <script>
  	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  	ga('create', 'UA-80636532-1', 'auto');
  	ga('send', 'pageview');
    </script>
  </body>
</html>
