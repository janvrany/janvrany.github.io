<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Jan Vraný - </title>
    <link rel="stylesheet" href="/pygments.css">
    <link rel="stylesheet" href="/stylesheet.css">
    

    <!-- you don't need to keep this, but it's cool for stats! -->
    <meta name="generator" content="Nanoc 4.8.18">
  </head>
  <body>
    <div id="header">
      <div id="jv">
        Jan Vraný
      </div>

    	<ul>
    	<li><a href="/">home</a></li>
    	<li><a href="/posts">blog</a></li>
        <li><a href="/projects">projects</a></li>                      
        <li><a href="https://bitbucket.org/janvrany/">repositories</a></li>
        <li><a href="/contact">contact</a></li>        
        <li><a href="/cv.pdf">cv</a></li>
    	</ul>
    </div>
    <div id="main">
      <div class="posts">
  
    
      
        <div class='post'>
          <h1><a href="/2018/01/fun-with-zfs-part-2-creating-debian-zfs-rescue-usb-image.html">Fun with ZFS, part 2: Creating Debian ZFS Rescue USB Image</a></h1>
          <aside>Posted at: January 4, 2018</aside>
          <article>
            
<p>While ZFS is supposedly very stable and reliable it’s not an integral part
of Linux and likely never will be (due to licensing issues). Because of that,
upgrading kernel or the  operating system may go wrong. Well, so far in my
case of Debian Jessie it was very smooth, but you never know. I have heard of
people whose experience was not that great.</p>

<p>Since I plan to do an OS upgrade, I want to be ready for the case the upgrade
go wrong and I won’t be able to boot the OS stored on ZFS filesystem. In that
case, one needs a a bootable live system with ZFS ready-to-use. Ideally the
same version you’re already running (or planning to run) on the system one wants
to upgrade.</p>

<p>In case of Debian, creating such an image turned out to be very very simple…
<!-- more --></p>

<h2 id="creating-debian-live-rescue-image-with-zfs">Creating Debian Live Rescue Image with ZFS</h2>

<p>Debian have tool named <em>live-build</em> <a href="https://debian-live.alioth.debian.org/live-manual/stable/manual/html/live-manual.en.html">1</a>. The easies way to get is just</p>

<pre><code>sudo apt-get install live-build
</code></pre>

<p>Once installed:</p>

<ol>
  <li>
    <p>Create a (temporary) working directory where it all happens:</p>

    <pre><code>mkdir /tmp/debian-streatch-live+zfs
cd /tmp/debian-streatch-live+zfs
</code></pre>
  </li>
  <li>
    <p>Generate initial configuration:</p>

    <pre><code>lb config \
  --distribution stretch \
  --architectures=amd64 \
  --binary-images iso-hybrid \
  --iso-volume "Debian Stretch ZFS Rescue Live" \
 	   --archive-areas "main contrib" \
 	   --linux-packages "linux-image linux-headers"
</code></pre>

    <p>We should include <em>contrib</em> in archives since that’s where ZFS packages are.
You may want to pass <code>--backports</code> if you want to include backports
repositories. The <code>--linux-packages</code> is to include kernel headers necessary to
compile ZFS kernel modules.</p>
  </li>
  <li>
    <p>Configure additional packages to be installed, most importantly the ZFS packages:</p>

    <pre><code>echo "
zfs-dkms
less
curl
wget
openssh-client
openssh-server
openssh-sftp-server
" &gt;&gt; config/package-lists/my.list.chroot
</code></pre>
  </li>
  <li>
    <p>Build the live root filesystem:</p>

    <pre><code>sudo lb bootstrap
sudo lb chroot
</code></pre>
  </li>
  <li>
    <p>Build the hybrid ISO binary:</p>

    <pre><code>sudo lb binary
</code></pre>

    <p>After this step, you should find the resulting ISO image in <code>live-image-amd64.hybrid.iso</code>.</p>
  </li>
  <li>
    <p><em>Profit!</em></p>
  </li>
</ol>

<h2 id="using-the-rescue-image">Using the Rescue Image</h2>

<p>By default, ZFS kernel module is not loaded, so:</p>

<pre><code>sudo modprobe zfs
</code></pre>

<p>Then you need to import pools:</p>

<pre><code>sudo zpool import
</code></pre>

<p>It may happen that pools were not cleanly exported. Then you’d have to import them with
<code>-f</code> flag (a.k.a. force):</p>

<pre><code>sudo zpoool import -f tank
</code></pre>

<p>You may check status of pools by:</p>

<pre><code>sudo zpool status
</code></pre>

<p>Only do so if you’re absolutely sure no other system is accessing the pool at the
time. But if you run ZFS normal PC with couple SATA disks attached like me and
the PC is currently running the live rescue image than you should be fine.</p>

<p>Mount host’s root filesystem to <code>/tmp/host</code>:</p>

<pre><code>mkdir /tmp/host
mount -t zfs tank/host/root /dev/host
</code></pre>

<p>Now you can <code>chroot /dev/host /bin/bash</code> and do what you want to create ZFS
snapshot, whatever you wish. Just make sure that once you’re done you export
pools so they can be cleanly imported by the host.</p>

<pre><code>sudo zpool export tank
</code></pre>

<h2 id="some-comments">Some Comments</h2>

<ol>
  <li>
    <p>The configuration for <code>lb</code> command is stored in <code>config</code> directory. The
<code>lb config</code> with various parameters just modifies (or creates if it does
 not exit) contents of the <code>config</code>. It may be a good idea to put the
 <code>config</code> into under version control such as Mercurial or git.</p>
  </li>
  <li>
    <p>The live image produced as above is really minimal, there’s not even a
<code>man</code>. You may want to add more packages. To do so, simply add them
to the <code>config/package-lists/my.list.chroot</code>. You may pull in a whole
GNOME by adding <code>gnome-desktop</code> package (though I have not tried).</p>
  </li>
</ol>

<p>To wrap it up, the process of building live Debian image is surprisingly easy.
Kudos to Debian people!</p>


          </article>
        </div>
      
    
      
        <div class='post'>
          <h1><a href="/2017/08/csr-mini-howto.html">How to generate TSL/SSL certificate and get it signed</a></h1>
          <aside>Posted at: August 17, 2017</aside>
          <article>
            
<h2 id="introduction">Introduction</h2>

<p>I recently had a need to provide an access to my private <a href="https://openvpn.net/">OpenVPN</a> server
to couple of friends / colleagues. I ran my very own <a href="https://en.wikipedia.org/wiki/Certificate_authority">CA</a> for the purpose
of issuing certificates for <a href="https://openvpn.net/">OpenVPN</a> clients. Usually I generate a key and
(signed) certificate and give it to the client in a secure-enough way, e.g on
my own USB stick.</p>

<p>In this case these guys live far, far away, so far that it’s impractical to meet
them face-to-face. Indeed I can generate key and certificate as usual, send them
these over an email (or a Jabber, Slack channel, you name it). I’d rather not to
do so, these channels are unsafe so someone may intercept and steal both the
key and the certificate. Let’s do it properly, after all the whole point of VPN
is to have a secure access and if the process of exchanging credentials is 
insecure, it somewhat spoils the idea.</p>

<p>How to issue them a working signed certificate in a secure way? 
That’s the question…I hope this would shed some light on this.</p>

<div class='read-more'><a href='/2017/08/csr-mini-howto.html'>Continue reading &rsaquo;</a></div>
          </article>
        </div>
      
    
      
        <div class='post'>
          <h1><a href="/2017/06/stx-libjava-used-for-real.html">STX:LIBJAVA used for real</a></h1>
          <aside>Posted at: June 7, 2017</aside>
          <article>
            
<p>No long ago I learned that <a href="https://swing.fit.cvut.cz/projects/stx-jv">Smalltalk/X jv-branch</a> and <a href="https://swing.fit.cvut.cz/projects/stx-libjava">STX:LIBJAVA</a> are 
used for real, in “industry”.</p>

<div class='read-more'><a href='/2017/06/stx-libjava-used-for-real.html'>Continue reading &rsaquo;</a></div>
          </article>
        </div>
      
    
      
        <div class='post'>
          <h1><a href="/2017/06/unamaged-delegates.html">Unmanaged delegates in CLR</a></h1>
          <aside>Posted at: June 7, 2017</aside>
          <article>
            
<p>As we progressed with <a href="/2016/10/a-taste-of-dotNET-in-Bee-Smalltalk.html">CLR interop for Bee Smalltalk</a>, a need to create 
a delegate for an unmanaged code arose. By “a delegate for an unmanaged code” I mean
an instance of a <a href="https://docs.microsoft.com/en-us/dotnet/articles/csharp/programming-guide/delegates/">delegate</a> object that can be passed to CLR code which, when
called, would execute an unmanaged code. In our case a Smalltalk code.</p>

<p>This can be handy, maybe necessary, if we want write a code that handles
events. And we may well would like to do so, writing some UI code using .NET
classes without use of event handlers seems to be impossible. Moreover, there
are other interesting events we may want to handle, such as 
<a href="https://msdn.microsoft.com/en-us/library/system.appdomain.firstchanceexception%28v=vs.110%29.aspx">AppDomain.FirstChanceException</a>.</p>

<p>Looking at the .NET documentation. this seem to be an easy task. Just use 
<a href="https://msdn.microsoft.com/en-us/library/zdx6dyyh%28v=vs.110%29.aspx">Marshal.GetDelegateForFunctionPointer()</a> to create a delegate object for
an arbitrary function pointer. Looks easy but it turned out to be a little more
tricky. And not very well documented. The following text describes my findings
and my solution so far. Mainly for my (our) own record but someone else may find 
useful too.</p>

<div class='read-more'><a href='/2017/06/unamaged-delegates.html'>Continue reading &rsaquo;</a></div>
          </article>
        </div>
      
    
      
        <div class='post'>
          <h1><a href="/2017/01/debugging-mixed-native-clr-application-in-windbg.html">Debugging mixed native-CLR application in WinDBG</a></h1>
          <aside>Posted at: January 25, 2017</aside>
          <article>
            
<p>While working on <a href="/2016/10/a-taste-of-dotNET-in-Bee-Smalltalk.html">CLR interop for Bee Smalltalk</a>, things go wrong every now and
again. This is tricky to debug, at least for me, as there is Smalltalk code,
then some native C++ code (CLR’s CCW and all this stuff) and finally managed
CLR code.</p>

<p>Obviously, Smalltalk debugger is kind of useless here as one would not see
native nor managed stack there. Managed debugger is can be useful to see what’s
happening in managed code, but quite often it got confused because we’re calling
CLR from native application so more often than not all it tells you is that
something went wrong - in case you don’t know that yet.</p>

<div class='read-more'><a href='/2017/01/debugging-mixed-native-clr-application-in-windbg.html'>Continue reading &rsaquo;</a></div>
          </article>
        </div>
      
    
      
        <div class='post'>
          <h1><a href="/2016/10/a-taste-of-dotNET-in-Bee-Smalltalk.html">A taste of .NET in Bee Smalltalk</a></h1>
          <aside>Posted at: October 13, 2016</aside>
          <article>
            
<p>Couple days ago, I finally managed to get .NET to do a job for me. Not much but 
still .NET did its job and did it well. The following text shows how to call
.NET code from Bee Smalltalk and retrieve results. I won’t go into technical 
details on how it’s done internally, rather show the usage from user point of
view. The goal is to give you an idea how it might feel to call .NET code from
Bee Smalltalk.</p>

<div class='read-more'><a href='/2016/10/a-taste-of-dotNET-in-Bee-Smalltalk.html'>Continue reading &rsaquo;</a></div>
          </article>
        </div>
      
    
      
        <div class='post'>
          <h1><a href="/2016/10/fun-with-zfs-part-1-installing-debian-jessie-on-zfs-root.html">Fun with ZFS, part 1: Installing Debian Jessie on ZFS Root</a></h1>
          <aside>Posted at: October 6, 2016</aside>
          <article>
            
<h2 id="preface">Preface</h2>

<p>Couple weeks ago I decided to make myself a small home server. Home sever, 
sounds weird, doesn’t it? Home’s not work place, no?</p>

<p>Well, it is, in my case. I have no need for media center, downloading and 
streaming movies or even playing on TV, nothing like this. But I need a  storage
 for backups and host to run virtual machines on.</p>

<div class='read-more'><a href='/2016/10/fun-with-zfs-part-1-installing-debian-jessie-on-zfs-root.html'>Continue reading &rsaquo;</a></div>
          </article>
        </div>
      
    
      
        <div class='post'>
          <h1><a href="/2016/10/first-post.html">First Post</a></h1>
          <aside>Posted at: October 6, 2016</aside>
          <article>
            
<p>I’m interested in many things. I have many ideas, all of them seem cool 
initially but as soon as I try to explain them, most of them turn out to be
rubbish.</p>

<div class='read-more'><a href='/2016/10/first-post.html'>Continue reading &rsaquo;</a></div>
          </article>
        </div>
      
    
  
</div>
    </div>
    <script>
  	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  	ga('create', 'UA-80636532-1', 'auto');
  	ga('send', 'pageview');
    </script>
  </body>
</html>
